<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>School Chess</title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background: #111;
      color: white;
      font-family: system-ui, sans-serif;
    }

    h1 {
      margin-bottom: 20px;
      font-size: 28px;
    }

    .board {
      display: grid;
      grid-template-columns: repeat(8, 64px);
      grid-template-rows: repeat(8, 64px);
      border: 4px solid #222;
      position: relative;
    }

    .square {
      width: 64px;
      height: 64px;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      position: relative;
      user-select: none;

      /* Ensures highlights go UNDER the piece */
      z-index: 0;
    }

    /* Chess.com colors */
    .light { background: #eeeed2; }
    .dark  { background: #769656; }

    /* Selected (orange outline) stays on the square, under piece */
    .selected {
      outline: 3px solid orange;
      outline-offset: -3px;
    }

    /* LEGAL MOVE highlight (yellow) under piece */
    .legal-move::after {
      content: "";
      position: absolute;
      inset: 0;
      background: rgba(255, 255, 0, 0.32);
      pointer-events: none;
      z-index: 0;
    }

    /* LAST MOVE highlight (darker green) under piece */
    .last-move::after {
      content: "";
      position: absolute;
      inset: 0;
      background: rgba(20, 94, 20, 0.45); /* DARK green */
      pointer-events: none;
      z-index: 0;
    }

    /* When both apply */
    .last-move.legal-move::after {
      background: rgba(120, 150, 0, 0.45);
    }

    /* PIECES ALWAYS ABOVE HIGHLIGHTS */
    .square img {
      max-width: 90%;
      max-height: 90%;
      pointer-events: none;
      position: relative;
      z-index: 2; /* over all highlights */
    }

    .drag-piece {
      position: absolute;
      pointer-events: none;
      width: 64px;
      height: 64px;
      z-index: 999; /* top of EVERYTHING */
    }

    #info {
      margin-top: 15px;
      opacity: 0.8;
    }
  </style>
</head>

<body>

  <h1>School Chess</h1>

  <div id="board" class="board"></div>
  <div id="info"></div>

  <script>
    const PIECE_URL = "https://www.chess.com/chess-themes/pieces/neo/150";

    function pieceImage(piece) {
      return `${PIECE_URL}/${piece.color}${piece.type}.png`;
    }

    const game = new Chess();
    let selected = null;
    let legalMoves = [];
    let lastMove = null;

    let dragging = false;
    let dragImg = null;
    let dragFrom = null;

    const boardEl = document.getElementById("board");
    const infoEl = document.getElementById("info");

    function sqName(file, rank) {
      return String.fromCharCode(97 + file) + (8 - rank);
    }

    function renderBoard() {
      boardEl.innerHTML = "";

      for (let r = 0; r < 8; r++) {
        for (let f = 0; f < 8; f++) {
          const sq = sqName(f, r);
          const div = document.createElement("div");
          div.classList.add("square", (r + f) % 2 === 0 ? "light" : "dark");
          div.dataset.square = sq;

          const piece = game.get(sq);
          if (piece) {
            const img = document.createElement("img");
            img.src = pieceImage(piece);
            img.draggable = false;
            div.appendChild(img);

            div.onpointerdown = (e) => startDrag(e, sq, piece);
          }

          if (sq === selected) div.classList.add("selected");
          if (legalMoves.includes(sq)) div.classList.add("legal-move");
          if (lastMove && (lastMove.from === sq || lastMove.to === sq))
            div.classList.add("last-move");

          div.addEventListener("click", onClick);
          boardEl.appendChild(div);
        }
      }
    }

    function onClick(e) {
      const sq = e.currentTarget.dataset.square;
      const piece = game.get(sq);

      if (dragging) return;

      if (!selected) {
        if (!piece || piece.color !== game.turn()) return;
        selectSquare(sq);
        return;
      }

      if (sq === selected) {
        clearSelection();
        return;
      }

      if (piece && piece.color === game.turn() && !legalMoves.includes(sq)) {
        selectSquare(sq);
        return;
      }

      if (legalMoves.includes(sq)) {
        makeMove(selected, sq);
        return;
      }

      clearSelection();
    }

    function selectSquare(sq) {
      const piece = game.get(sq);
      selected = sq;
      legalMoves = game.moves({ square: sq, verbose: true }).map(m => m.to);
      infoEl.textContent = `Selected ${piece.color} ${piece.type} on ${sq}`;
      renderBoard();
    }

    function clearSelection() {
      selected = null;
      legalMoves = [];
      infoEl.textContent = "";
      renderBoard();
    }

    function makeMove(from, to) {
      const move = game.move({ from, to, promotion: "q" });
      if (move) lastMove = { from: move.from, to: move.to };
      clearSelection();
    }

    function startDrag(e, sq, piece) {
      if (piece.color !== game.turn()) return;

      dragging = true;
      dragFrom = sq;
      selectSquare(sq);

      dragImg = document.createElement("img");
      dragImg.src = pieceImage(piece);
      dragImg.classList.add("drag-piece");
      document.body.appendChild(dragImg);

      moveDrag(e);

      window.onpointermove = moveDrag;
      window.onpointerup = endDrag;
    }

    function moveDrag(e) {
      if (!dragging || !dragImg) return;
      dragImg.style.left = e.pageX - 32 + "px";
      dragImg.style.top = e.pageY - 32 + "px";
    }

    function endDrag(e) {
      if (!dragging) return;

      dragging = false;
      dragImg.remove();
      dragImg = null;

      const elementUnder = document.elementFromPoint(e.clientX, e.clientY);
      const dropSq = elementUnder?.dataset?.square;

      if (dropSq && legalMoves.includes(dropSq)) {
        makeMove(dragFrom, dropSq);
      } else {
        clearSelection();
      }

      window.onpointermove = null;
      window.onpointerup = null;
    }

    renderBoard();
  </script>

</body>
</html>
