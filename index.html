<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>School Chess</title>

  <!-- Correct browser-safe version of chess.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background: #111;
      color: #fff;
      font-family: system-ui, sans-serif;
    }

    h1 {
      margin-bottom: 8px;
    }

    .subtitle {
      margin-bottom: 14px;
      opacity: 0.85;
      font-size: 0.9rem;
    }

    .board {
      display: grid;
      grid-template-columns: repeat(8, 64px);
      grid-template-rows: repeat(8, 64px);
      border: 4px solid #222;
    }

    .square {
      width: 64px;
      height: 64px;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      position: relative;
      user-select: none;
    }

    /* Chess.com colors */
    .light {
      background: #eeeed2;
    }
    .dark {
      background: #769656;
    }

    /* Highlight colors */
    .selected {
      outline: 3px solid orange;
      outline-offset: -3px;
    }

    .legal-move {
      box-shadow: inset 0 0 0 4px yellow;
    }

    .last-move {
      box-shadow: inset 0 0 0 4px #4caf50;
    }

    .square img {
      max-width: 90%;
      max-height: 90%;
      pointer-events: none;
    }

    #info {
      margin-top: 12px;
      font-size: 0.9rem;
      opacity: 0.85;
    }
  </style>
</head>

<body>
  <h1>School Chess</h1>

  <div id="board" class="board"></div>
  <div id="info"></div>

  <script>
    const PIECE_URL = "https://assets-themes.chess.com/image/ejgv/150";

    function pieceImage(piece) {
      const prefix = piece.color === "w" ? "w" : "b";
      return `${PIECE_URL}/${prefix}${piece.type}.png`;
    }

    const game = new Chess();
    let selectedSquare = null;
    let legalMoves = [];
    let lastMove = null;

    const boardEl = document.getElementById("board");
    const infoEl = document.getElementById("info");

    function squareName(file, rank) {
      return String.fromCharCode(97 + file) + (8 - rank);
    }

    function renderBoard() {
      boardEl.innerHTML = "";

      for (let rank = 0; rank < 8; rank++) {
        for (let file = 0; file < 8; file++) {
          const sq = squareName(file, rank);
          const square = document.createElement("div");
          square.classList.add("square");

          const isLight = (rank + file) % 2 === 0;
          square.classList.add(isLight ? "light" : "dark");

          square.dataset.square = sq;

          const piece = game.get(sq);
          if (piece) {
            const img = document.createElement("img");
            img.src = pieceImage(piece);
            square.appendChild(img);
          }

          if (sq === selectedSquare) square.classList.add("selected");
          if (legalMoves.includes(sq)) square.classList.add("legal-move");

          if (lastMove && (lastMove.from === sq || lastMove.to === sq)) {
            square.classList.add("last-move");
          }

          square.addEventListener("click", onSquareClick);
          boardEl.appendChild(square);
        }
      }
    }

    function onSquareClick(e) {
      const sq = e.currentTarget.dataset.square;
      const piece = game.get(sq);

      if (!selectedSquare) {
        if (!piece || piece.color !== game.turn()) return;

        selectedSquare = sq;
        legalMoves = game.moves({ square: sq, verbose: true }).map(m => m.to);

        infoEl.textContent = `Selected ${piece.color === "w" ? "White" : "Black"} ${piece.type.toUpperCase()} on ${sq}`;
        renderBoard();
        return;
      }

      if (sq === selectedSquare) {
        selectedSquare = null;
        legalMoves = [];
        infoEl.textContent = "";
        renderBoard();
        return;
      }

      if (piece && piece.color === game.turn() && !legalMoves.includes(sq)) {
        selectedSquare = sq;
        legalMoves = game.moves({ square: sq, verbose: true }).map(m => m.to);
        infoEl.textContent = `Selected ${piece.color === "w" ? "White" : "Black"} ${piece.type.toUpperCase()} on ${sq}`;
        renderBoard();
        return;
      }

      if (legalMoves.includes(sq)) {
        const move = game.move({
          from: selectedSquare,
          to: sq,
          promotion: "q"
        });

        if (move) lastMove = { from: move.from, to: move.to };

        selectedSquare = null;
        legalMoves = [];
        infoEl.textContent = `Moved from ${move.from} to ${move.to}`;
        renderBoard();
        return;
      }

      selectedSquare = null;
      legalMoves = [];
      infoEl.textContent = "";
      renderBoard();
    }

    renderBoard();
  </script>
</body>
</html>
