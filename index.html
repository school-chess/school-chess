<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>School Chess</title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background: #111;
      color: white;
      font-family: system-ui, sans-serif;
      overflow: hidden;
    }

    h1 { margin-bottom: 20px; }

    .board {
      display: grid;
      grid-template-columns: repeat(8, 64px);
      grid-template-rows: repeat(8, 64px);
      border: 4px solid #222;
      position: relative;
    }

    .square {
      width: 64px;
      height: 64px;
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
      cursor: pointer;
      user-select: none;
      z-index: 0;
    }

    /* Chess.com colors */
    .light { background: #eeeed2; }
    .dark  { background: #769656; }

    /* Selected: orange outline */
    .selected {
      outline: 3px solid orange;
      outline-offset: -3px;
    }

    /* Legal moves: yellow overlay under piece */
    .legal-move::after {
      content: "";
      position: absolute;
      inset: 0;
      background: rgba(255, 255, 0, 0.32);
      z-index: 0;
      pointer-events: none;
    }

    /* Last move: thicker, lighter green highlight under piece */
    .last-move::after {
      content: "";
      position: absolute;
      inset: 0;
      background: rgba(150, 255, 150, 0.45);
      box-shadow: 0 0 6px rgba(150, 255, 150, 0.9);
      z-index: 0;
      pointer-events: none;
    }

    .last-move.legal-move::after {
      background: rgba(200, 255, 120, 0.55);
      box-shadow: 0 0 8px rgba(200, 255, 120, 0.9);
    }

    .square img {
      max-width: 90%;
      max-height: 90%;
      z-index: 2;
      position: relative;
      /* pointer-events: none;  <-- removed so dragging works */
    }

    /* Drag clone that follows the cursor */
    .drag-piece {
      position: absolute;
      width: 64px;
      height: 64px;
      z-index: 9999;
      pointer-events: none;
    }

    #info { margin-top: 15px; opacity: 0.8; }
  </style>
</head>

<body>

  <h1>School Chess</h1>
  <div id="board" class="board"></div>
  <div id="info"></div>

<script>
const PIECE_URL = "https://www.chess.com/chess-themes/pieces/neo/150";

function pieceImage(piece) {
  return `${PIECE_URL}/${piece.color}${piece.type}.png`;
}

const game = new Chess();

let selected = null;
let legalMoves = [];
let lastMove = null;

let dragging = false;
let dragFrom = null;
let dragClone = null;
let dragSourceImg = null;
let dragOffsetX = 0;
let dragOffsetY = 0;

const boardEl = document.getElementById("board");
const infoEl = document.getElementById("info");

function sqName(file, rank) {
  return String.fromCharCode(97 + file) + (8 - rank);
}

function renderBoard() {
  boardEl.innerHTML = "";

  for (let r = 0; r < 8; r++) {
    for (let f = 0; f < 8; f++) {
      const sq = sqName(f, r);

      const div = document.createElement("div");
      div.classList.add("square", (r + f) % 2 === 0 ? "light" : "dark");
      div.dataset.square = sq;

      const piece = game.get(sq);
      if (piece) {
        const img = document.createElement("img");
        img.src = pieceImage(piece);
        img.draggable = false;

        // pointerdown on the IMG starts drag
        img.onpointerdown = (e) => startDrag(e, sq, img, piece);

        div.appendChild(img);
      }

      if (sq === selected) div.classList.add("selected");
      if (legalMoves.includes(sq)) div.classList.add("legal-move");
      if (lastMove && (lastMove.from === sq || lastMove.to === sq))
        div.classList.add("last-move");

      // Click square only if we are not in a drag operation
      div.onclick = (e) => {
        if (dragging) return;
        onSquareClick(e);
      };

      boardEl.appendChild(div);
    }
  }
}

/* ---------- CLICK LOGIC ---------- */

function onSquareClick(e) {
  const sq = e.currentTarget.dataset.square;
  const piece = game.get(sq);

  if (!selected) {
    if (!piece || piece.color !== game.turn()) return;
    selectSquare(sq);
    return;
  }

  if (sq === selected) {
    clearSelection();
    return;
  }

  if (piece && piece.color === game.turn() && !legalMoves.includes(sq)) {
    selectSquare(sq);
    return;
  }

  if (legalMoves.includes(sq)) {
    makeMove(selected, sq);
    return;
  }

  clearSelection();
}

function selectSquare(sq) {
  const piece = game.get(sq);
  selected = sq;
  legalMoves = game.moves({ square: sq, verbose: true }).map(m => m.to);
  infoEl.textContent = `Selected ${piece.color} ${piece.type} on ${sq}`;
  renderBoard();
}

function clearSelection() {
  selected = null;
  legalMoves = [];
  infoEl.textContent = "";
  renderBoard();
}

function makeMove(from, to) {
  const move = game.move({ from, to, promotion: "q" });

  if (move) {
    lastMove = { from: move.from, to: move.to };
  }

  clearSelection();
}

/* ---------- DRAG LOGIC ---------- */

function startDrag(e, sq, img, piece) {
  // Only drag if it's that side's turn
  if (piece.color !== game.turn()) return;

  e.preventDefault();
  e.stopPropagation();

  dragging = true;
  dragFrom = sq;

  // Select the piece (shows orange + legal moves)
  selectSquare(sq);

  // Hide the original piece while dragging
  dragSourceImg = img;
  dragSourceImg.style.opacity = "0";

  // Create a clone that follows the cursor
  dragClone = img.cloneNode(true);
  dragClone.classList.add("drag-piece");
  document.body.appendChild(dragClone);

  const rect = img.getBoundingClientRect();
  dragOffsetX = e.clientX - rect.left;
  dragOffsetY = e.clientY - rect.top;

  moveDrag(e);

  window.addEventListener("pointermove", moveDrag);
  window.addEventListener("pointerup", endDrag);
}

function moveDrag(e) {
  if (!dragging || !dragClone) return;

  dragClone.style.left = (e.pageX - dragOffsetX) + "px";
  dragClone.style.top = (e.pageY - dragOffsetY) + "px";
}

function getSquareFromPoint(x, y) {
  let el = document.elementFromPoint(x, y);
  while (el && !el.dataset?.square) {
    el = el.parentElement;
  }
  return el?.dataset?.square || null;
}

function endDrag(e) {
  if (!dragging) return;
  dragging = false;

  // Remove drag clone
  if (dragClone) {
    dragClone.remove();
    dragClone = null;
  }

  // Reveal the original piece again
  if (dragSourceImg) {
    dragSourceImg.style.opacity = "1";
    dragSourceImg = null;
  }

  const dropSq = getSquareFromPoint(e.clientX, e.clientY);

  if (dropSq && legalMoves.includes(dropSq)) {
    // Valid move
    makeMove(dragFrom, dropSq);
  } else if (dropSq === dragFrom) {
    // Dropped on same square → keep selection & highlights
    selectSquare(dragFrom);
  } else {
    // Anywhere else → clear selection
    clearSelection();
  }

  dragFrom = null;

  window.removeEventListener("pointermove", moveDrag);
  window.removeEventListener("pointerup", endDrag);
}

renderBoard();
</script>

</body>
</html>
